<!-- <!DOCTYPE html> -->
<html>
  <head>
  <meta charset="utf-8" />
  <title>WebSocket Test</title>
  <style>
    #video_container
    {
      display:block;
      position: absolute;

      border: 5px solid #FFFF00;
      /* background-color: #EEEEEE; */
    }

    .video_minimized
    {
      top: 0px;
      right: 0px;
      width: 240px;
      height: 240px;
    }

    .video_fullscreen
    {
      top: 0px;
      bottom: 0px;
      right: 0px;
      left: 0px;
      width: 100%;
      height: 100%;
    }

    #video
    {
      backface-visibility: visible;
    }
    body{
      background-color: #EEEEEE;
    }
  </style>
  </head>
  <body>
    <h2>WebSocket Test</h2>
    <button id="btn">Reset</button>
    <div id="video_container" class="video_minimized">
      <video id="video" width="240" height="240">
        <source src="test_h264.mp4" type="video/mp4">
        Your browser does not support the video tag.
      </video>
    </div>
    <div id="output"></div>
  
  <script type="text/javascript">
    // var wsUri = "wss://echo.websocket.org/";
    // var wsUri = "ws://"+window.location.host;

    var autoReconnectInterval = 3000;
    var server_ip = "10.0.1.2:3000"
    var wsUri = (window.location.host =="localhost:3000")?"ws://localhost:3000":"ws://"+server_ip;
    var output;

    var welcomeMessage = "Connected to WebSocket. You're lovely.";

    // aWss.clients.forEach(function (client) {
    //   client.send('hello');
    // });

    function init()
    {
      output = document.getElementById("output");
      writeToScreen("DOCUMENT LOADED");
      createSocketServer();
    }
  
    function createSocketServer()
    {
      websocket = new WebSocket(wsUri);
      websocket.onopen = function(evt) { onOpen(evt) };
      websocket.onclose = function(evt) { onClose(evt) };
      websocket.onmessage = function(evt) { onMessage(evt) };
      websocket.onerror = function(evt) { onError(evt) };
    }
  
    function onOpen(evt)
    {
      writeToScreen("CONNECTED");
      doSend(welcomeMessage);
      fullscreen(); 
    }
    
    function fullscreen( minimize )
    {
      var v = document.getElementById("video_container");
        // v.className = ( minimize == true ) ? ( "video_minimized" ) : ( "video_fullscreen" );
    }

    function onClose(evt)
    {
      writeToScreen("DISCONNECTED");
      if(evt.code != 1000)      
			  reconnect(evt);
    }
  
    function onMessage(evt)
    {
      writeToScreen('<span style="color: blue;">RESPONSE: ' + evt.data+'</span>');
      
      switch(evt.data)
      {
        case "Play Video":
          play();
          break;
        case welcomeMessage:

        default:
          break;
      }
      // websocket.close();
    }
  
    function play()
    {
      var v = document.getElementById("video");
      v.currentTime = 0;
      v.play();
    }

    function onError(evt)
    {
      if(evt.code == "ECONNREFUSED")
        reconnect(evt);

      writeToScreen('<span style="color: red;">ERROR:</span> ' + evt.data);
      fullscreen(true); 
    }
  
    function doSend(message)
    {
      writeToScreen("SENT: " + message);
      websocket.send(message);
    }
  
    function reconnect(evt){
      writeToScreen("RETRY RECONNECT IN..."+autoReconnectInterval);
      setTimeout(function(){
        writeToScreen("RECONNECTING...");
        createSocketServer();
      },autoReconnectInterval);
    }

    function writeToScreen(message)
    {
      var d = new Date();
      var pre = document.createElement("p"); 
      pre.style.wordWrap = "break-word";
      pre.innerHTML =  d.getTime() + "\n" + message;
      output.appendChild(pre);
    }
  
    window.addEventListener("load", init, false);
    </script>
    <script type="text/javascript">
      var b = document.getElementById("btn");
      b.onclick = () => {
        doSend("Play Video");
      };
    </script> 
    </body>       
  </html>